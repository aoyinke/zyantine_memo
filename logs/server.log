
============================================================
自衍体 AI API 服务
============================================================
服务地址: http://0.0.0.0:8001
API 文档: http://0.0.0.0:8001/docs
会话ID: default
============================================================

/opt/anaconda3/envs/zyantine_genisis/lib/python3.11/site-packages/websockets/legacy/__init__.py:6: DeprecationWarning: websockets.legacy is deprecated; see https://websockets.readthedocs.io/en/stable/howto/upgrade.html for upgrade instructions
  warnings.warn(  # deprecated in 14.0 - 2024-11-09
/opt/anaconda3/envs/zyantine_genisis/lib/python3.11/site-packages/uvicorn/protocols/websockets/websockets_impl.py:17: DeprecationWarning: websockets.server.WebSocketServerProtocol is deprecated
  from websockets.server import WebSocketServerProtocol
INFO:     Started server process [99973]
INFO:     Waiting for application startup.
正在初始化自衍体 AI 系统...
2025-12-30 18:15:03 - facade - INFO - 自衍体AI系统初始化中...
2025-12-30 18:15:03 - facade_structured - INFO - {"timestamp": "2025-12-30T18:15:03.143716", "level": "INFO", "message": "系统初始化开始", "config_path": null, "session_id": "default"}
2025-12-30 18:15:03 - api_service_provider - INFO - 初始化API服务，模型: gpt-4.1-nano-2025-04-14, URL: https://openkey.cloud/v1...
2025-12-30 18:15:04 - openai_service - INFO - 初始连接测试成功
2025-12-30 18:15:04 - openai_service - INFO - OpenAI服务初始化完成，模型: gpt-4.1-nano-2025-04-14
2025-12-30 18:15:05 - api_service_provider - INFO - OpenAI服务初始化成功，模型: gpt-4.1-nano-2025-04-14
2025-12-30 18:15:05 - prompt_engine - INFO - 提示词引擎初始化完成
2025-12-30 18:15:05 - fallback_strategy - INFO - 降级策略管理器初始化完成
2025-12-30 18:15:05 - reply_generator - INFO - 回复生成器初始化完成
2025-12-30 18:15:05 - api_service_provider - INFO - API服务提供者初始化完成
[记忆系统] 初始化完成，用户ID: default_user，会话ID: default
[记忆管理器] 初始化完成，会话: default
[事实检查器] API事实审查已启用
[协议引擎] 初始化完成，集成以下协议：
  - 事实检查协议
  - 长度规整协议
  - 表达验证协议
[协议引擎] 初始化完成，集成以下协议：
  - 事实检查协议
  - 长度规整协议
  - 表达验证协议
2025-12-30 18:15:06 - ZyantineCore - INFO - 系统核心初始化完成，会话ID: default
2025-12-30 18:15:06 - facade - INFO - 自衍体AI系统 v1.0.0 初始化完成
2025-12-30 18:15:06 - facade - INFO - 会话ID: default
2025-12-30 18:15:06 - facade - INFO - 系统模式: standard
2025-12-30 18:15:06 - facade - INFO - 记忆系统: memo0
2025-12-30 18:15:06 - facade - INFO - 认知流程: 标准版
INFO:     Application startup complete.
INFO:     Uvicorn running on http://0.0.0.0:8001 (Press CTRL+C to quit)
/opt/anaconda3/envs/zyantine_genisis/lib/python3.11/site-packages/websockets/legacy/server.py:1178: DeprecationWarning: remove second argument of ws_handler
  warnings.warn("remove second argument of ws_handler", DeprecationWarning)
INFO:     127.0.0.1:55476 - "WebSocket /ws" [accepted]
INFO:     connection open
系统初始化完成，会话ID: default
客户端 default 已连接，当前连接数: 1

[DEBUG] 收到 WebSocket 消息 (client_id=default):
  消息类型: websocket.receive
  文本数据长度: 66
  数据内容: '{"type": "connect", "client_id": "test_multi_turn_20251230181511"}'

[DEBUG] JSON 解析成功:
  消息类型: connect
  完整数据: {'type': 'connect', 'client_id': 'test_multi_turn_20251230181511'}

[DEBUG] 收到 WebSocket 消息 (client_id=default):
  消息类型: websocket.receive
  文本数据长度: 62
  数据内容: '{"type": "chat", "message": "你好，我叫小明", "model": "zyantine-v1"}'

[DEBUG] JSON 解析成功:
  消息类型: chat
  完整数据: {'type': 'chat', 'message': '你好，我叫小明', 'model': 'zyantine-v1'}

[DEBUG] 聊天消息处理:
  用户消息: '你好，我叫小明'
  消息长度: 7
  消息编码: b'\xe4\xbd\xa0\xe5\xa5\xbd\xef\xbc\x8c\xe6\x88\x91\xe5\x8f\xab\xe5\xb0\x8f\xe6\x98\x8e'
  模型: zyantine-v1

[DEBUG] 调用 facade.chat()...
2025-12-30 18:15:11 - facade - INFO - 接收用户输入: 你好，我叫小明...
2025-12-30 18:15:11 - facade_structured - INFO - {"timestamp": "2025-12-30T18:15:11.291552", "level": "INFO", "message": "处理用户输入", "input_preview": "你好，我叫小明", "input_length": 7}
2025-12-30 18:15:11 - ZyantineCore - INFO - 开始处理用户输入: 你好，我叫小明...
2025-12-30 18:15:11 - ZyantineCore - ERROR - 处理过程中发生异常: 'str' object has no attribute 'get'
2025-12-30 18:15:11 - ZyantineCore - ERROR - 生成错误响应: 'str' object has no attribute 'get'
2025-12-30 18:15:11 - facade - INFO - 响应生成成功，长度: 23, 耗时: 0.017秒
2025-12-30 18:15:11 - facade_structured - INFO - {"timestamp": "2025-12-30T18:15:11.308373", "level": "INFO", "message": "响应生成完成", "response_preview": "我的思考过程出现了一些混乱，能请你再问一次吗？", "response_length": 23, "response_time": 0.016531944274902344}

[DEBUG] facade.chat() 返回:
  响应: '我的思考过程出现了一些混乱，能请你再问一次吗？'
  响应长度: 23

[DEBUG] 发送响应 JSON:
  JSON: '{"type": "response", "message": "我的思考过程出现了一些混乱，能请你再问一次吗？", "model": "zyantine-v1", "timestamp": 1767089711}'

[DEBUG] 收到 WebSocket 消息 (client_id=default):
  消息类型: websocket.receive
  文本数据长度: 61
  数据内容: '{"type": "chat", "message": "我今年25岁", "model": "zyantine-v1"}'

[DEBUG] JSON 解析成功:
  消息类型: chat
  完整数据: {'type': 'chat', 'message': '我今年25岁', 'model': 'zyantine-v1'}

[DEBUG] 聊天消息处理:
  用户消息: '我今年25岁'
  消息长度: 6
  消息编码: b'\xe6\x88\x91\xe4\xbb\x8a\xe5\xb9\xb425\xe5\xb2\x81'
  模型: zyantine-v1

[DEBUG] 调用 facade.chat()...
2025-12-30 18:15:12 - facade - INFO - 接收用户输入: 我今年25岁...
2025-12-30 18:15:12 - facade_structured - INFO - {"timestamp": "2025-12-30T18:15:12.310782", "level": "INFO", "message": "处理用户输入", "input_preview": "我今年25岁", "input_length": 6}
2025-12-30 18:15:12 - ZyantineCore - INFO - 开始处理用户输入: 我今年25岁...
2025-12-30 18:15:12 - ZyantineCore - ERROR - 处理过程中发生异常: 'str' object has no attribute 'get'
2025-12-30 18:15:12 - ZyantineCore - ERROR - 生成错误响应: 'str' object has no attribute 'get'
2025-12-30 18:15:12 - facade - INFO - 响应生成成功，长度: 23, 耗时: 0.017秒
2025-12-30 18:15:12 - facade_structured - INFO - {"timestamp": "2025-12-30T18:15:12.327769", "level": "INFO", "message": "响应生成完成", "response_preview": "我的思考过程出现了一些混乱，能请你再问一次吗？", "response_length": 23, "response_time": 0.016764163970947266}

[DEBUG] facade.chat() 返回:
  响应: '我的思考过程出现了一些混乱，能请你再问一次吗？'
  响应长度: 23

[DEBUG] 发送响应 JSON:
  JSON: '{"type": "response", "message": "我的思考过程出现了一些混乱，能请你再问一次吗？", "model": "zyantine-v1", "timestamp": 1767089712}'

[DEBUG] 收到 WebSocket 消息 (client_id=default):
  消息类型: websocket.receive
  文本数据长度: 65
  数据内容: '{"type": "chat", "message": "你还记得我的名字吗？", "model": "zyantine-v1"}'

[DEBUG] JSON 解析成功:
  消息类型: chat
  完整数据: {'type': 'chat', 'message': '你还记得我的名字吗？', 'model': 'zyantine-v1'}

[DEBUG] 聊天消息处理:
  用户消息: '你还记得我的名字吗？'
  消息长度: 10
  消息编码: b'\xe4\xbd\xa0\xe8\xbf\x98\xe8\xae\xb0\xe5\xbe\x97\xe6\x88\x91\xe7\x9a\x84\xe5\x90\x8d\xe5\xad\x97\xe5\x90\x97\xef\xbc\x9f'
  模型: zyantine-v1

[DEBUG] 调用 facade.chat()...
2025-12-30 18:15:13 - facade - INFO - 接收用户输入: 你还记得我的名字吗？...
2025-12-30 18:15:13 - facade_structured - INFO - {"timestamp": "2025-12-30T18:15:13.330148", "level": "INFO", "message": "处理用户输入", "input_preview": "你还记得我的名字吗？", "input_length": 10}
2025-12-30 18:15:13 - ZyantineCore - INFO - 开始处理用户输入: 你还记得我的名字吗？...
2025-12-30 18:15:13 - ZyantineCore - ERROR - 处理过程中发生异常: 'str' object has no attribute 'get'
2025-12-30 18:15:13 - ZyantineCore - ERROR - 生成错误响应: 'str' object has no attribute 'get'
2025-12-30 18:15:13 - facade - INFO - 响应生成成功，长度: 22, 耗时: 0.013秒
2025-12-30 18:15:13 - facade_structured - INFO - {"timestamp": "2025-12-30T18:15:13.342937", "level": "INFO", "message": "响应生成完成", "response_preview": "刚才的思考链路好像打了个结，我们重新开始吧。", "response_length": 22, "response_time": 0.012590885162353516}

[DEBUG] facade.chat() 返回:
  响应: '刚才的思考链路好像打了个结，我们重新开始吧。'
  响应长度: 22

[DEBUG] 发送响应 JSON:
  JSON: '{"type": "response", "message": "刚才的思考链路好像打了个结，我们重新开始吧。", "model": "zyantine-v1", "timestamp": 1767089713}'

[DEBUG] 收到 WebSocket 消息 (client_id=default):
  消息类型: websocket.receive
  文本数据长度: 64
  数据内容: '{"type": "chat", "message": "我刚才说我多大了？", "model": "zyantine-v1"}'

[DEBUG] JSON 解析成功:
  消息类型: chat
  完整数据: {'type': 'chat', 'message': '我刚才说我多大了？', 'model': 'zyantine-v1'}

[DEBUG] 聊天消息处理:
  用户消息: '我刚才说我多大了？'
  消息长度: 9
  消息编码: b'\xe6\x88\x91\xe5\x88\x9a\xe6\x89\x8d\xe8\xaf\xb4\xe6\x88\x91\xe5\xa4\x9a\xe5\xa4\xa7\xe4\xba\x86\xef\xbc\x9f'
  模型: zyantine-v1

[DEBUG] 调用 facade.chat()...
2025-12-30 18:15:14 - facade - INFO - 接收用户输入: 我刚才说我多大了？...
2025-12-30 18:15:14 - facade_structured - INFO - {"timestamp": "2025-12-30T18:15:14.346587", "level": "INFO", "message": "处理用户输入", "input_preview": "我刚才说我多大了？", "input_length": 9}
2025-12-30 18:15:14 - ZyantineCore - INFO - 开始处理用户输入: 我刚才说我多大了？...
2025-12-30 18:15:14 - ZyantineCore - ERROR - 处理过程中发生异常: 'str' object has no attribute 'get'
2025-12-30 18:15:14 - ZyantineCore - ERROR - 生成错误响应: 'str' object has no attribute 'get'
2025-12-30 18:15:14 - facade - INFO - 响应生成成功，长度: 22, 耗时: 0.012秒
2025-12-30 18:15:14 - facade_structured - INFO - {"timestamp": "2025-12-30T18:15:14.358884", "level": "INFO", "message": "响应生成完成", "response_preview": "刚才的思考链路好像打了个结，我们重新开始吧。", "response_length": 22, "response_time": 0.011926889419555664}

[DEBUG] facade.chat() 返回:
  响应: '刚才的思考链路好像打了个结，我们重新开始吧。'
  响应长度: 22

[DEBUG] 发送响应 JSON:
  JSON: '{"type": "response", "message": "刚才的思考链路好像打了个结，我们重新开始吧。", "model": "zyantine-v1", "timestamp": 1767089714}'

[DEBUG] 收到 WebSocket 消息 (client_id=default):
  消息类型: websocket.receive
  文本数据长度: 57
  数据内容: '{"type": "chat", "message": "再见", "model": "zyantine-v1"}'

[DEBUG] JSON 解析成功:
  消息类型: chat
  完整数据: {'type': 'chat', 'message': '再见', 'model': 'zyantine-v1'}

[DEBUG] 聊天消息处理:
  用户消息: '再见'
  消息长度: 2
  消息编码: b'\xe5\x86\x8d\xe8\xa7\x81'
  模型: zyantine-v1

[DEBUG] 调用 facade.chat()...
2025-12-30 18:15:15 - facade - INFO - 接收用户输入: 再见...
2025-12-30 18:15:15 - facade_structured - INFO - {"timestamp": "2025-12-30T18:15:15.360796", "level": "INFO", "message": "处理用户输入", "input_preview": "再见", "input_length": 2}
2025-12-30 18:15:15 - ZyantineCore - INFO - 开始处理用户输入: 再见...
2025-12-30 18:15:15 - ZyantineCore - ERROR - 处理过程中发生异常: 'str' object has no attribute 'get'
2025-12-30 18:15:15 - ZyantineCore - ERROR - 生成错误响应: 'str' object has no attribute 'get'
2025-12-30 18:15:15 - facade - INFO - 响应生成成功，长度: 23, 耗时: 0.013秒
2025-12-30 18:15:15 - facade_structured - INFO - {"timestamp": "2025-12-30T18:15:15.373828", "level": "INFO", "message": "响应生成完成", "response_preview": "我的思考过程出现了一些混乱，能请你再问一次吗？", "response_length": 23, "response_time": 0.012686014175415039}
INFO:     connection closed
INFO:     Shutting down
INFO:     Waiting for application shutdown.

[DEBUG] facade.chat() 返回:
  响应: '我的思考过程出现了一些混乱，能请你再问一次吗？'
  响应长度: 23

[DEBUG] 发送响应 JSON:
  JSON: '{"type": "response", "message": "我的思考过程出现了一些混乱，能请你再问一次吗？", "model": "zyantine-v1", "timestamp": 1767089715}'

[DEBUG] 收到 WebSocket 消息 (client_id=default):
  消息类型: websocket.receive
  文本数据长度: 17
  数据内容: '{"type": "close"}'

[DEBUG] JSON 解析成功:
  消息类型: close
  完整数据: {'type': 'close'}
发送消息时发生意外错误 (client_id=default): 
客户端 default 已断开，当前连接数: 0
正在关闭系统...

正在关闭系统...
2025-12-30 18:19:10 - ZyantineCore - INFO - 正在关闭系统...
2025-12-30 18:19:10 - api_service_provider - INFO - 正在关闭API服务提供者...
2025-12-30 18:19:10 - openai_service - INFO - 正在关闭OpenAI服务...
2025-12-30 18:19:10 - openai_service - INFO - OpenAI服务已关闭
2025-12-30 18:19:10 - api_service_provider - INFO - 已关闭服务: openai
2025-12-30 18:19:10 - api_service_provider - INFO - API服务提供者已关闭
2025-12-30 18:19:10 - ZyantineCore - INFO - 正在保存记忆系统到: ./memory_backups/default_20251230_181910.json
[记忆系统] 记忆导出成功: ./memory_backups/default_20251230_181910.json
[记忆管理器] 记忆导出成功: ./memory_backups/default_20251230_181910.json
2025-12-30 18:19:10 - api_service_provider - INFO - 正在关闭API服务提供者...
2025-12-30 18:19:10 - openai_service - INFO - 正在关闭OpenAI服务...
2025-12-30 18:19:10 - openai_service - INFO - OpenAI服务已关闭
2025-12-30 18:19:10 - api_service_provider - INFO - 已关闭服务: openai
2025-12-30 18:19:10 - api_service_provider - INFO - API服务提供者已关闭
2025-12-30 18:19:10 - ZyantineCore - INFO - 系统关闭完成
2025-12-30 18:19:10 - facade - INFO - 系统已关闭
INFO:     Application shutdown complete.
INFO:     Finished server process [99973]
