# 使用真实智谱AI API的优化计划

## 优化目标
1. 修改LLMClient类，使用真实的智谱AI API调用
2. 从llm_config.json配置文件读取API密钥
3. 完善README.md文件，添加智谱AI API的配置和使用说明

## 实现步骤

### 1. 修改LLMClient类
**添加智谱AI API支持**：
- 修改`_call_api`方法，使用真实的智谱AI API调用
- 添加`_fallback_evaluation`方法，当API调用失败时使用
- 确保从配置文件读取API密钥

**具体实现**：
- 导入`ZhipuAiClient`类
- 修改`_call_api`方法，实现真实的API调用
- 添加错误处理和备用逻辑

### 2. 修改llm_config.json文件
**配置智谱AI API**：
- 启用智谱AI配置
- 添加API密钥
- 配置模型参数

**具体修改**：
- 将`zhipu.enabled`设置为`true`
- 添加API密钥到`zhipu.api_key`
- 配置合适的模型和参数

### 3. 完善README.md文件
**添加智谱AI API说明**：
- 添加智谱AI API的配置说明
- 添加使用真实大模型API的示例
- 说明如何从配置文件读取API密钥

**具体添加**：
- 在LLM提供商配置部分添加智谱AI配置示例
- 添加使用智谱AI API的代码示例
- 说明如何获取和配置API密钥

## 技术实现

### LLMClient类修改
```python
# 修改_call_api方法
def _call_api(self, prompt: str, model: str = "glm-4.7") -> str:
    """调用智谱AI API"""
    try:
        from zai import ZhipuAiClient
        client = ZhipuAiClient(api_key=self.api_key)
        
        response = client.chat.completions.create(
            model=model,
            messages=[
                {"role": "system", "content": "你是一个记忆系统的评估助手，负责评估对话内容的价值和重要性。"},
                {"role": "user", "content": prompt}
            ],
            max_tokens=65536,
            temperature=1.0
        )
        
        return response.choices[0].message.content.strip()
    except Exception as e:
        print(f"[LLMClient] API调用失败: {e}")
        # 使用备用逻辑
        return self._fallback_evaluation(prompt)

# 添加备用评估逻辑
def _fallback_evaluation(self, prompt: str) -> str:
    """备用评估逻辑"""
    if "内容价值评估" in prompt or "评分" in prompt:
        content = prompt.split("内容：")[1].split("评分：")[0].strip()
        if len(content) < 3:
            return "0"
        elif any(word in content for word in ["重要", "会议", "项目", "电话", "号码"]):
            return "8"
        elif any(word in content for word in ["你好", "天气", "忙", "工作"]):
            return "5"
        else:
            return "3"
    elif "搜索查询增强" in prompt:
        query = prompt.split("原始查询：")[1].split("增强查询：")[0].strip()
        return query
    else:
        return ""
```

### llm_config.json修改
```json
{
  "api": {
    "enabled": true,
    "provider": "zhipu",
    "providers": {
      "zhipu": {
        "enabled": true,
        "api_key": "199d6b2011494a2f96530090f4cecddc.HDEJEZurnkpgCLkC",
        "base_url": "https://open.bigmodel.cn/api/paas/v4",
        "chat_model": "glm-4.7",
        "timeout": 30,
        "max_retries": 3
      }
    }
  }
}
```

### README.md完善
**添加智谱AI API配置说明**：
- 在LLM提供商配置部分添加智谱AI配置示例
- 添加使用智谱AI API的代码示例
- 说明如何获取和配置API密钥

**添加智谱AI API使用示例**：
```python
# 使用智谱AI API
from zai import ZhipuAiClient

client = ZhipuAiClient(api_key="your-api-key")
response = client.chat.completions.create(
    model="glm-4.7",
    messages=[
        {"role": "user", "content": "作为一名营销专家，请为我的产品创作一个吸引人的口号"},
        {"role": "assistant", "content": "当然，要创作一个吸引人的口号，请告诉我一些关于您产品的信息"},
        {"role": "user", "content": "智谱AI开放平台"}
    ],
    max_tokens=65536,
    temperature=1.0
)

print(response.choices[0].message)
```

## 预期效果

1. **真实API调用**：系统将使用真实的智谱AI API进行内容评估和查询增强
2. **配置文件读取**：API密钥将从llm_config.json配置文件读取
3. **文档完善**：README.md文件将包含智谱AI API的配置和使用说明
4. **稳定性**：当API调用失败时，系统将使用备用逻辑，确保稳定性

## 代码修改范围

主要修改文件：
- `zyantine_genisis/memory/memory_store.py`：修改LLMClient类
- `zyantine_genisis/config/llm_config.json`：配置智谱AI API
- `README.md`：完善文档

修改方法：
- 修改现有方法，实现真实的API调用
- 配置文件中添加API密钥
- 文档中添加配置和使用说明

## 注意事项

1. **API密钥安全**：确保API密钥安全存储，不要硬编码在代码中
2. **错误处理**：确保添加适当的错误处理，当API调用失败时使用备用逻辑
3. **性能优化**：考虑添加缓存机制，减少API调用次数
4. **依赖管理**：确保安装了必要的依赖包（如`zai`包）