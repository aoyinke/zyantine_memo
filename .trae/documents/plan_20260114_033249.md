# 记忆系统优化计划（使用大模型API）

## 优化目标
根据测试结果，记忆系统存在以下问题需要解决：
1. 无意义信息存储：系统存储了无意义的对话内容
2. 重复信息存储：系统未对重复信息进行有效去重
3. 搜索结果不准确：搜索算法需要优化
4. 访问统计失效：访问次数跟踪机制有问题
5. 记忆管理效率低：缺乏自动清理机制

## 优化方案

### 1. 对话内容过滤机制（使用大模型API）
**实现内容价值评估**：
- 利用大模型API评估对话内容的价值
- 开发算法评估对话内容的价值，过滤无意义信息
- 设置阈值，对低于阈值的内容（如单个语气词）直接过滤

**具体实现**：
- 添加 `_evaluate_content_value` 方法，调用大模型API评估内容价值
- 在 `add_memory` 方法中调用该方法，过滤低价值内容
- 对无意义内容（如"嗯..."、"啊..."等）直接返回特殊ID

### 2. 记忆重要性评估（使用大模型API）
**重要性评分系统**：
- 利用大模型API评估内容重要性
- 基于内容类型、关键词等因素，计算重要性评分
- 优先存储高重要性信息，限制低重要性信息的存储

**具体实现**：
- 添加 `_calculate_importance_score` 方法，调用大模型API计算内容重要性
- 在 `add_memory` 方法中使用评分结果，决定是否存储
- 为不同类型的内容设置不同的重要性阈值

### 3. 重复信息处理
**相似度检测**：
- 实现更精确的相似度检测算法
- 对高度相似的内容采用合并或跳过策略
- 版本管理，对重复但有细微差别的内容进行版本管理

**具体实现**：
- 添加 `_check_duplicate_content` 方法，检测重复内容
- 在 `add_memory` 方法中调用该方法，处理重复信息
- 对重复内容采用更新策略，而非重新存储

### 4. 记忆自动清理机制
**定期清理**：
- 实现定期清理功能，清理低价值记忆
- 设置存储限额，超过限额时自动清理低价值记忆
- 基于重要性、访问频率等因素排序，优先保留高价值记忆

**具体实现**：
- 添加 `cleanup_memory` 方法，清理低价值记忆
- 实现 `_sort_memories_by_value` 方法，按价值排序记忆
- 提供定期清理的API和自动清理机制

### 5. 搜索算法优化（使用大模型API）
**语义理解**：
- 利用大模型API增强搜索查询的语义理解
- 结合标签进行更精确的搜索
- 优化搜索结果的排序机制，提高相关性

**具体实现**：
- 添加 `_enhance_search_query` 方法，调用大模型API增强查询
- 优化 `search_memories` 方法，改进搜索逻辑
- 改进搜索结果排序，提高相关性

### 6. 访问统计修复
**修正访问统计**：
- 确保正确跟踪记忆的访问次数
- 基于访问次数和时间计算记忆热度
- 实现智能缓存，基于热度优化存储

**具体实现**：
- 修复 `search_memories` 方法中的访问统计逻辑
- 确保 `get_memory` 方法正确更新访问统计
- 添加 `_calculate_memory_heat` 方法，计算记忆热度

## 大模型API使用策略

### 1. API调用优化
- **批量处理**：批量评估多个内容的价值和重要性
- **缓存结果**：缓存评估结果，避免重复调用
- **异步调用**：使用异步API调用，提高性能
- **错误处理**：实现优雅的错误处理，当API不可用时使用备用算法

### 2. 评估提示词设计
**内容价值评估提示词**：
```
请评估以下对话内容的价值，从0到10评分，0表示无意义，10表示非常重要。
内容：{content}
评分：
```

**重要性评估提示词**：
```
请评估以下对话内容的重要性，从0到10评分，0表示不重要，10表示非常重要。
内容：{content}
评分：
```

**搜索查询增强提示词**：
```
请增强以下搜索查询，使其更准确地表达语义，保持核心含义不变。
原始查询：{query}
增强查询：
```

## 实现步骤

1. **添加大模型API调用模块**：
   - 实现 `LLMClient` 类，封装大模型API调用
   - 添加错误处理和缓存机制

2. **实现内容过滤和重要性评估**：
   - 添加 `_evaluate_content_value` 方法
   - 添加 `_calculate_importance_score` 方法
   - 修改 `add_memory` 方法，集成过滤和评估逻辑

3. **实现重复信息处理**：
   - 添加 `_check_duplicate_content` 方法
   - 修改 `add_memory` 方法，处理重复信息

4. **添加记忆自动清理机制**：
   - 实现 `cleanup_memory` 方法
   - 实现 `_sort_memories_by_value` 方法
   - 添加自动清理的配置选项

5. **优化搜索算法**：
   - 添加 `_enhance_search_query` 方法
   - 优化 `search_memories` 方法
   - 改进搜索结果排序

6. **修复访问统计**：
   - 修复 `search_memories` 中的访问统计逻辑
   - 确保 `get_memory` 正确更新访问统计

7. **测试和验证**：
   - 运行测试脚本验证优化效果
   - 检查记忆存储行为是否符合预期
   - 验证搜索结果准确性

## 预期效果

1. **减少无意义信息存储**：系统不再存储无意义的对话内容
2. **避免重复信息存储**：系统对重复信息进行有效去重
3. **提高搜索准确性**：搜索结果更加准确，相关性更高
4. **正确跟踪访问统计**：访问次数和热度计算准确
5. **优化记忆管理**：自动清理低价值记忆，提高存储效率
6. **智能评估**：利用大模型API实现更智能的内容评估

## 代码修改范围

主要修改文件：
- `zyantine_genisis/memory/memory_store.py`：核心优化逻辑
- 可能需要修改 `zyantine_genisis/memory/memory_manager.py`：配合优化

修改方法：
- 添加新的辅助方法
- 修改现有方法，集成优化逻辑
- 确保向后兼容性，不破坏现有功能
- 添加大模型API调用模块