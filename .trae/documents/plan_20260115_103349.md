## 修复API调用时的系统错误

### 问题分析

根据错误信息，系统在API调用时存在以下问题：

1. **记忆系统错误（Error code: 502）**：
   - 获取最近对话失败
   - 搜索记忆失败
   - 记录交互失败

2. **协议审查错误**：
   - `expected string or bytes-like object, got 'tuple'`
   - 协议审查阶段失败

3. **异步执行错误**：
   - `this event loop is already running`
   - 异步执行失败，回退到同步执行

### 修复方案

#### 1. 修复记忆系统的502错误

**修改文件：** `zyantine_genisis/memory/memory_store.py`

- **更新 `get_recent_conversations` 方法**：
  - 检查 `self.memory` 是否为本地回退对象
  - 当使用本地回退时，直接返回空列表或本地数据
  - 添加详细的错误处理和日志

- **更新 `search_memories` 方法**：
  - 检查 `self.memory` 是否为本地回退对象
  - 当使用本地回退时，返回本地搜索结果
  - 添加详细的错误处理和日志

- **更新 `add_memory` 方法**：
  - 检查 `self.memory` 是否为本地回退对象
  - 当使用本地回退时，使用本地添加方法
  - 添加详细的错误处理和日志

#### 2. 修复协议审查错误

**修改文件：** `zyantine_genisis/protocols/protocol_engine.py`

- 检查协议审查相关代码
- 确保传递正确的参数类型（字符串或字节对象）
- 修复类型错误，避免传递元组

#### 3. 修复异步执行错误

**修改文件：** `zyantine_genisis/core/processing_pipeline.py`

- **更新 `_execute_stage` 方法**：
  - 修复事件循环已经运行的错误
  - 使用适当的异步执行方式
  - 确保事件循环的正确使用

### 技术实现细节

1. **记忆系统修复**：
   - 在每个记忆操作方法中添加 `isinstance(self.memory, LocalMemory)` 检查
   - 当使用本地回退时，返回适当的本地结果
   - 添加详细的错误处理和日志

2. **协议审查修复**：
   - 检查协议审查时的参数类型
   - 确保传递字符串或字节对象
   - 添加类型检查和转换

3. **异步执行修复**：
   - 修复事件循环的使用
   - 当事件循环已经运行时，使用同步执行
   - 添加适当的错误处理

### 预期效果

修复后，系统应该能够：
- 在API调用失败时正确使用本地回退
- 避免协议审查时的类型错误
- 正确处理异步执行
- 提供清晰的错误信息和日志
- 保持系统的稳定运行

### 验证步骤

1. 启动系统，确保正常初始化
2. 发送测试请求，验证API调用是否正常
3. 检查日志，确保没有错误信息
4. 验证系统在各种情况下都能稳定运行