# 修复回复生成失败的问题

## 问题分析
根据错误信息 `TypeError("GenerationContext.__init__() got an unexpected keyword argument 'final_action_plan'")`，问题出在 `api/reply_generator.py` 文件中的 `_generate_with_legacy_api` 函数。当调用 `self._create_generation_context(**kwargs)` 时，传递了 `final_action_plan` 参数，但 `GenerationContext` 类期望的是 `action_plan` 参数。

## 原因分析
1. 检查了 `api/reply_generator.py` 文件中的 `GenerationContext` 类，发现它接受 `action_plan` 参数，而不是 `final_action_plan` 参数
2. 检查了 `core/stage_handlers.py` 文件中的 `ReplyGenerationHandler` 类的 `_build_generation_params` 方法，发现它构建的参数中使用了 `final_action_plan` 作为键

## 问题定位
经过详细分析，问题出在 `ReplyGenerationHandler` 类的 `_build_generation_params` 方法中。它构建的参数中使用了 `final_action_plan` 作为键，而 `GenerationContext` 类期望的是 `action_plan` 作为键。

## 解决方案
修改 `ReplyGenerationHandler` 类的 `_build_generation_params` 方法，将 `final_action_plan` 改为 `action_plan`，以匹配 `GenerationContext` 类的期望。

## 修复步骤
1. 打开 `core/stage_handlers.py` 文件
2. 修改 `ReplyGenerationHandler` 类的 `_build_generation_params` 方法，将 `final_action_plan` 改为 `action_plan`
3. 保存修改后的文件
4. 运行 API 服务器，测试修复是否成功