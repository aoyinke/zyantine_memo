# 记忆系统优化计划

## 问题分析

### 问题1：检索相关记忆时返回无关记忆
- **根本原因**：`find_resonant_memory` 方法只返回第一个匹配的记忆，没有进行充分的过滤和排序
- **具体表现**：搜索结果可能包含与当前上下文不相关的记忆
- **影响范围**：记忆检索准确性和系统响应质量

### 问题2：拼接记忆时只使用单条记忆
- **根本原因**：`_build_tactical_package` 方法只基于单个记忆构建信息包
- **具体表现**：系统无法整合多个相关记忆，导致记忆上下文不完整
- **影响范围**：记忆使用效果和用户体验

## 优化方案

### 1. 改进记忆检索机制
- **增强 `find_resonant_memory` 方法**：
  - 增加多记忆返回支持
  - 提高相似度阈值，过滤低相关性结果
  - 优化搜索结果排序算法

- **改进查询构建**：
  - 增强 `_build_resonance_query` 方法，提取更准确的查询关键词
  - 实现上下文感知的查询扩展

### 2. 实现多记忆拼接功能
- **创建新方法 `_build_combined_tactical_package`**：
  - 整合多个相关记忆
  - 确保记忆内容的连贯性
  - 构建更全面的记忆上下文

- **优化记忆融合逻辑**：
  - 基于时间顺序和相关性排序
  - 识别记忆之间的关联关系
  - 生成连贯的记忆叙述

### 3. 优化搜索参数和过滤
- **调整相似度阈值**：
  - 根据记忆类型动态调整阈值
  - 为不同类型的记忆设置不同的相关性标准

- **改进结果过滤**：
  - 基于记忆价值和重要性过滤
  - 考虑记忆的时效性

### 4. 增加记忆整合机制
- **实现记忆融合功能**：
  - 识别重复或重叠的记忆内容
  - 合并相关记忆的信息
  - 生成更全面的记忆摘要

- **提供记忆上下文信息**：
  - 增加记忆之间的关联信息
  - 提供记忆使用建议

## 预期效果

- **提高记忆检索准确性**：减少无关记忆的返回
- **增强记忆拼接效果**：整合多个相关记忆，提供更完整的上下文
- **改善系统响应质量**：基于更准确和全面的记忆信息
- **提升用户体验**：系统能够更好地理解和使用记忆信息

## 实施步骤

1. **修改 `find_resonant_memory` 方法**：支持多记忆返回
2. **创建 `_build_combined_tactical_package` 方法**：实现多记忆拼接
3. **优化搜索参数和过滤逻辑**：提高检索准确性
4. **测试和调整**：确保优化效果符合预期

## 技术要点

- 保持与现有代码风格一致
- 确保向后兼容性
- 优化性能，避免过度计算
- 提供清晰的日志和错误处理